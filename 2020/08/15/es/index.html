<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>中通Elasticsearch集群运维实践（二）--监控告警 | 科技中通</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="中通,技术,java,中间件,消息队列,程序员,开发工程师,blog,MQ,ES,ElasticSearch,网关,微服务,技术中台,中台"><meta name="description" content="中通科技是中通快递旗下的互联网物流科技平台，拥有一支千余人规模的研发团队，秉承“互联网+物流”的理念，致力于为客户和消费者提供卓越的物流科技产品与服务，助力产业数字化、智慧化不断发展。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://tech.izto.com/2020/08/15/es/index.html"><link rel="icon" type="image/png" href="https://izto.com/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="科技中通" type="application/atom+xml"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?9b7127cab937a0bb222bc7e3e2435c75";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 5.0.2"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(https://blog.static.minfive.com/other/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="科技中通" alt="科技中通"><img src="https://fscdn.zto.com/fs8/M03/5B/3D/wKhBEF83WreAWVZSAAAKUQSlLFk739.png" alt="科技中通"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/2020/08/15/es/time-line.png" alt="中通Elasticsearch集群运维实践（二）--监控告警"></div><header class="post__info"><h1 class="post__title">中通Elasticsearch集群运维实践（二）--监控告警</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/about/">中通技术团队</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2020-08-15</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/%E9%9B%86%E7%BE%A4/">集群</a></li><li class="mark__item"><a href="/tags/%E8%BF%90%E7%BB%B4/">运维</a></li><li class="mark__item"><a href="/tags/ES/">ES</a></li><li class="mark__item"><a href="/tags/%E6%90%9C%E7%B4%A2/">搜索</a></li><li class="mark__item"><a href="/tags/%E5%B9%B3%E5%8F%B0/">平台</a></li><li class="mark__item"><a href="/tags/%E7%9B%91%E6%8E%A7/">监控</a></li></ul></div></div></header><div class="post__content"><h4 id="背景介绍："><a href="#背景介绍：" class="headerlink" title="背景介绍："></a>背景介绍：</h4><p>中通在2015年的时候已经开始预研并在生产环境使用Elasticsearch集群，随后在科技中心开始大规模实践。随着业务的快速发展，es集群数量和规模也越来越大，版本的跨度也逐渐拉大，统一管理这些es集群逐渐变成了首要问题，在这种情况下，我们研发了中通ES运维监控平台–ESPaaS，提供了ES集群的自动化部署，统一监控，实时告警和索引管理等一系列运维管理功能，截止2020年7月底，中通生产上运行的es集群数量已经有40+个，节点数量500+个，单个集群的节点数从3个到100多个，单日新增文档数量近600亿，单日数据增量超过100tb，数据总量已经超6PB。</p><p>不同的阶段，关注和解决的问题也不一样，ESPaaS平台的版本迭代主要分为以下几个阶段：</p><img src="time-line.png"><p>本文主要介绍的是中通ESPaaS运维平台在统一监控告警上的实践，主要关注以下内容：</p><ol><li>集群实时监控</li><li>告警输出</li><li>集群诊断</li></ol><h4 id="架构设计"><a href="#架构设计" class="headerlink" title="架构设计"></a>架构设计</h4><p><code>prometheus</code>作为现在最流行的监控解决方案之一，经过一番调研，决定以<code>prometheus</code>为核心，搭建监控体系，监控告警的整体架构如下图所示：</p><img src="monitor.png"><p>整个监控模块围绕<code>prometheus</code>进行展开，主要的功能有：</p><ol><li>自研exporter获取线上es集群的关键指标信息，暴露的rest接口能根据请求中的集群名称返回不同集群的监控信息；</li><li>prometheus采取pull模式，定期请求exporter以获取es集群的监控信息；</li><li>grafana配置监控大盘对监控数据进行可视化；</li><li>告警应用给予promQL定期计算是否有指标异常，指标细化到各个es集群；</li><li>告警渠道目前主要采用钉钉，及时发送告警信息到钉钉群，快速定位问题集群、节点信息；</li><li>告警设立优先级，同时触发优先级高的先行发送，直指问题本质；</li><li>延迟告警避免偶发抖动造成的频繁告警与告警恢复；</li><li>诊断模块整合实时信息和历史监控趋势，发现潜在问题，消灭问题于萌芽状态；</li></ol><h4 id="集群监控与告警"><a href="#集群监控与告警" class="headerlink" title="集群监控与告警"></a>集群监控与告警</h4><p>为了保证ES集群的稳定运行，我们需要从多个维度对ES集群进行监控，主要的维度信息如下：</p><ul><li>资源类，包含部署ES机器的cpu、内存、网络、磁盘等信息；</li><li>集群级，ES集群本身是否处于健康状态，从一个较大的维度确认集群是否正常；</li><li>节点级，ES作为一个分布式的应用，每个节点的状态会最终影响集群的状态，需要对节点的jvm、线程池等进行监控；</li></ul><p>最终形成的监控大盘如下：</p><img src="monitor-1.png"><p>告警配置：</p><img src="warn-02.png"><p>告警信息：</p><img src="warn-dingding.png"><h4 id="集群诊断"><a href="#集群诊断" class="headerlink" title="集群诊断"></a>集群诊断</h4><p>上面的监控告警能帮助我们快速定位集群的现有的问题，但是从长远角度来看，我们需要在问题出现之前提前发现、提前解决，尽可能避免生产故障。带着这样的思考，我们决定提供es集群的诊断能力–将对问题的排查手段和实践经验进行复用，将其标准化，最终沉淀在我们的集群诊断模块中。</p><p>诊断模块的设计思想是核心指标量化，利用量化的指标来帮助我们明确优化方向和快速定位问题，总结日常的问题排查和解决经验，我们将诊断分为五个维度：</p><img src="cluster-judge.png"><p>集群诊断基本涵盖了日常处理es集群问题的大部分场景，通过集群诊断，我们能够提前发现集群的潜在问题，通过提前扩容，更改索引设计与使用方式等行为来规避可能的生产问题。在集群监控和诊断的保驾护航下，2020年至今ESPaaS运维平台管理的ES集群没有发生生产故障。</p><p>诊断建议的界面：</p><img src="zhenduan.png"><h4 id="实践经验"><a href="#实践经验" class="headerlink" title="实践经验"></a>实践经验</h4><p>在监控告警和集群诊断的实际开发与使用过程中，我们也积累了很多的经验。</p><h5 id="1、es集群突然无法写入了，应用日志中全部都是写入失败的记录？"><a href="#1、es集群突然无法写入了，应用日志中全部都是写入失败的记录？" class="headerlink" title="1、es集群突然无法写入了，应用日志中全部都是写入失败的记录？"></a>1、es集群突然无法写入了，应用日志中全部都是写入失败的记录？</h5><p>在实际的问题排查中，发现大部分情况下都是集群部分节点磁盘超过90%触发当前节点的索引read_only，导致无法写入。</p><p>解决措施：</p><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"># 解除索引只读</span><br><span class="line">PUT _all/_settings</span><br><span class="line">&#123;</span><br><span class="line">  <span class="string">&quot;index.blocks.read_only_allow_delete&quot;</span>:<span class="string">&quot;false&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure><p>发生磁盘超过水位线的问题，一方面是对索引或者集群的容量规划做的不到位，另一方面也是监控告警的缺乏导致问题最终发生了。在引入监控告警后，我们对各个ES集群的磁盘设置了告警水位线，80%是告警的阈值，在集群的磁盘超标前，能够发送告警信息，让我们有时间和业务方提前沟通清理数据释放部分磁盘空间。在集群诊断中，我们依据磁盘过去一段时间的使用比例线性预测一天、七天后的使用量，提前和业务方进行沟通，对可能出现问题的集群提前进行扩容，避免出现资源瓶颈。</p><h5 id="2、监控大盘的信息解读"><a href="#2、监控大盘的信息解读" class="headerlink" title="2、监控大盘的信息解读"></a>2、监控大盘的信息解读</h5><p>监控大盘的引入，将监控指标以图表的形式展示出来，让我们能够直观的看到监控指标的当前数值和变化趋势，能帮助我们快速对es集群的资源利用率，性能瓶颈有一个大致的认知.通过下面的监控信息可以看出：</p><ol><li>集群当前是green状态，节点分布是 1master+13data节点；</li><li>主分片数量197，分片数量较少，不会出现单个节点数千个分片的情况；</li><li>多数节点节点在7:00-8:00gc较为频繁，此时段可能为业务高峰期，可能会有大量的写入或者查询等操作；</li><li>整体堆内存占用在50-70%之间，证明集群整体资源暂时没有瓶颈；</li><li>gc次数和gc耗时的面板发现有节点出现毛刺，可以通过分片监控查看是否分片分配不均匀导致了热节点；</li></ol><img src="monitor-2.png"><h5 id="3、频繁告警的处理"><a href="#3、频繁告警的处理" class="headerlink" title="3、频繁告警的处理"></a>3、频繁告警的处理</h5><p>在告警功能初次上线时，有些集群的资源使用率比较高，部分节点内存占用超标了，当时的告警策略是一分钟检测一次，如果有异常就产生告警。这会带来频繁告警的问题，如果问题修复的时间较长，那每分钟都会产生一次告警信息，造成告警信息轰炸，告警群的告警信息全部都是同一条，不禁让人厌烦，还会导致开发小伙伴忽略其他的告警内容。</p><p>面对这种情况，参考一些业界的告警设计，在初次告警后，再次触发的告警不再立马发出，而是给予不同的时间间隔，如果在告警半小时后，问题没有解决，指标依旧异常，则产生第二次钉钉告警，告警间隔逐级顺延直至恢复，大大减少了重复的告警数量。</p><h5 id="4、延迟告警的设计"><a href="#4、延迟告警的设计" class="headerlink" title="4、延迟告警的设计"></a>4、延迟告警的设计</h5><p>内部的日志es集群，会存储近2月的日志索引，但是7天前的默认会关闭，由于经常有同学需要排查历史问题需要开启已经closed掉的索引，在索引开启的过程中，会造成日志es集群的短暂red/yellow状态，导致触发告警后又立即恢复，在钉钉告警群中大量刷消息。</p><p>面对这种能够自恢复的问题，我们决定设置延迟告警的策略，如果在告警触发的数分钟内(可配置)，告警指标恢复正常则不再进行告警，将这类偶发的抖动问题变成静默状态，不再干扰正常的告警。</p><h4 id="脚踏实地，展望未来"><a href="#脚踏实地，展望未来" class="headerlink" title="脚踏实地，展望未来"></a>脚踏实地，展望未来</h4><ol><li><p>ES容器化</p><blockquote><p>kubernetes的应用越来越广泛，ES+k8s将是中通在有状态服务上的探索与尝试；</p></blockquote></li><li><p>ES-Proxy–提供搜索服务</p><blockquote><p>未来希望将ES提供的搜索能力标准化，用户通过proxy使用ES，不必关心具体ES集群部署和索引分布；</p></blockquote></li></ol><div class="post-announce">感谢您的阅读，本文由 <a href="http://tech.izto.com">科技中通</a> 版权所有。如若转载，请注明出处：科技中通（<a href="http://tech.izto.com/2020/08/15/es/">http://tech.izto.com/2020/08/15/es/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2020/08/15/kafka/" title="Kafka 节点重启失败导致数据丢失的分析排查与解决之道"><i class="iconfont icon-prev"></i>Kafka 节点重启失败导致数据丢失的分析排查与解决之道</a></div><div class="post__prev post__prev--right"></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">中通科技是中通快递旗下的互联网物流科技平台，拥有一支千余人规模的研发团队，秉承“互联网+物流”的理念，致力于为客户和消费者提供卓越的物流科技产品与服务，助力产业数字化、智慧化不断发展。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2020/08/15/es/" title="中通Elasticsearch集群运维实践（二）--监控告警"><div class="item__cover"><img src="/2020/08/15/es/time-line.png" alt="中通Elasticsearch集群运维实践（二）--监控告警"></div><div class="item__info"><h3 class="item__title">中通Elasticsearch集群运维实践（二）--监控告警</h3><span class="item__text">2020-08-15</span></div></a></li><li class="latest-post-item"><a href="/2020/08/15/kafka/" title="Kafka 节点重启失败导致数据丢失的分析排查与解决之道"><div class="item__cover"><img src="/2020/08/15/kafka/640.jpeg" alt="Kafka 节点重启失败导致数据丢失的分析排查与解决之道"></div><div class="item__info"><h3 class="item__title">Kafka 节点重启失败导致数据丢失的分析排查与解决之道</h3><span class="item__text">2020-08-15</span></div></a></li><li class="latest-post-item"><a href="/2020/08/15/zms/" title="中通消息服务运维平台实践（已开源）"><div class="item__cover"><img src="/2020/08/15/zms/1.png" alt="中通消息服务运维平台实践（已开源）"></div><div class="item__info"><h3 class="item__title">中通消息服务运维平台实践（已开源）</h3><span class="item__text">2020-08-15</span></div></a></li><li class="latest-post-item"><a href="/2019/10/15/elasticsearch/" title="中通Elasticsearch集群运维实践"><div class="item__cover"><img src="/2019/10/15/elasticsearch/0640.jpeg" alt="中通Elasticsearch集群运维实践"></div><div class="item__info"><h3 class="item__title">中通Elasticsearch集群运维实践</h3><span class="item__text">2019-10-15</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/API/">API</a></li><li class="tag-item"><a class="tag-link" href="/tags/App/">App</a></li><li class="tag-item"><a class="tag-link" href="/tags/ES/">ES</a></li><li class="tag-item"><a class="tag-link" href="/tags/Gateway/">Gateway</a></li><li class="tag-item"><a class="tag-link" href="/tags/HBase/">HBase</a></li><li class="tag-item"><a class="tag-link" href="/tags/Kafka/">Kafka</a></li><li class="tag-item"><a class="tag-link" href="/tags/MQ/">MQ</a></li><li class="tag-item"><a class="tag-link" href="/tags/RocketMQ/">RocketMQ</a></li><li class="tag-item"><a class="tag-link" href="/tags/Spark/">Spark</a></li><li class="tag-item"><a class="tag-link" href="/tags/Test/">Test</a></li><li class="tag-item"><a class="tag-link" href="/tags/es/">es</a></li><li class="tag-item"><a class="tag-link" href="/tags/http/">http</a></li><li class="tag-item"><a class="tag-link" href="/tags/kabana/">kabana</a></li><li class="tag-item"><a class="tag-link" href="/tags/okhttp/">okhttp</a></li><li class="tag-item"><a class="tag-link" href="/tags/onedata/">onedata</a></li><li class="tag-item"><a class="tag-link" href="/tags/scoket/">scoket</a></li><li class="tag-item"><a class="tag-link" href="/tags/tcp/">tcp</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E4%B8%AD%E9%80%9A/">中通</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%8A%9F%E8%80%97/">功耗</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%8D%8F%E8%AE%AE/">协议</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%AE%9E%E8%B7%B5/">实践</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B9%B3%E5%8F%B0/">平台</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%90%9C%E7%B4%A2/">搜索</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%8F%B0/">数据中台</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%97%A5%E5%BF%97/">日志</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%B6%88%E6%81%AF/">消息</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%99%BE%E4%BA%BF/">百亿</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%9B%91%E6%8E%A7/">监控</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%A7%BB%E5%8A%A8/">移动</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%BD%91%E5%85%B3/">网关</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E9%9B%86%E7%BE%A4/">集群</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，采用skapp主题，主要用于技术分享，欢迎点击右下角订阅 rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>上海青浦</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>xiaowenke@zto.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="https://izto.com/static/img/wx.9dba3bb.png" alt="logo" title="科技中通"></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://www.zto.com/" title="中通快递" target="_blank">中通快递</a></li><li class="list-item"><a href="https://izto.com/" title="科技中通" target="_blank">科技中通</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="skapp主题" target="_blank">skapp主题</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">构建工具</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo博客</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/ZTO-Express" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:xiaowenke@zto.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["集群","运维","ES","搜索","平台","监控"],gitalk=new Gitalk({clientID:"4cb968a54b00e64ac3cb",clientSecret:"394030211a8ab592146f31cbf54bb9090c0f82d9",repo:"zto-express.github.io",owner:"ZTO-Express",admin:["ZTOGroup"],labels:tags,id:new Date(1597458774e3).getTime()>new Date("2018-02-15").getTime()?md5(location.href):location.href});gitalk.render("comment-container")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>