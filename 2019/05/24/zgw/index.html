<!DOCTYPE html><html lang="zh-cn"><head><meta charset="utf-8"><title>中通API网关实践 | 科技中通</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="中通,技术,java,中间件,消息队列,程序员,开发工程师,blog,MQ,ES,ElasticSearch,网关,微服务,技术中台,中台"><meta name="description" content="中通科技是中通快递旗下的互联网物流科技平台，拥有一支千余人规模的研发团队，秉承“互联网+物流”的理念，致力于为客户和消费者提供卓越的物流科技产品与服务，助力产业数字化、智慧化不断发展。"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="http://tech.izto.com/2019/05/24/zgw/index.html"><link rel="icon" type="image/png" href="https://izto.com/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="科技中通" type="application/atom+xml"><script>var _hmt=_hmt||[];!function(){var e=document.createElement("script");e.src="https://hm.baidu.com/hm.js?9b7127cab937a0bb222bc7e3e2435c75";var t=document.getElementsByTagName("script")[0];t.parentNode.insertBefore(e,t)}()</script><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 5.0.2"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(https://blog.static.minfive.com/other/loader.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="科技中通" alt="科技中通"><img src="https://fscdn.zto.com/fs8/M03/5B/3D/wKhBEF83WreAWVZSAAAKUQSlLFk739.png" alt="科技中通"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/2019/05/24/zgw/0640.jpeg" alt="中通API网关实践"></div><header class="post__info"><h1 class="post__title">中通API网关实践</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/about/">中通技术团队</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2019-05-24</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/API/">API</a></li><li class="mark__item"><a href="/tags/Gateway/">Gateway</a></li><li class="mark__item"><a href="/tags/%E7%BD%91%E5%85%B3/">网关</a></li></ul></div></div></header><div class="post__content"><p>背景</p><p>在微服务的概念流行之前，API网关就已经存在了，最初是作为开放平台，面向合作伙伴提供OpenApi。随着后来微服务的流行，API网关作为系统边界，将所有的服务聚集在一起，是统一的入口，这就要求API网关能够满足不同类型应用、不同场景的需求；在技术上，也面临着可用性、灵活性、安全性等不同的挑战。<br>随着中通内部应用的大量开发，越来越多的业务系统需要能够快速开发接入，而且要保证安全稳定。所以我们决定采用网关来代理后端服务，同时抽取统一管控服务的流控、鉴权、负载均衡等等，目前市面上已经存在一些开源的网关系统，比如Spring Cloud、Kong等等，由于现在系统中已经存在大量的dubbo服务，所以我们决定通过自研网关来实现网关的通用功能以及一些定制化的开发。</p><p>使用场景</p><p><strong>在中通，网关主要有以下几种使用场景：</strong><br><strong>1. 面向第三方合作平台：</strong> 我们将内部的下单、物流查询等接口通过API网关提供给商家、合作伙伴调用；</p><p><strong>2. 面向移动APP；</strong></p><p><strong>3. 面向WEB应用：</strong> 一般在前后端分离的场景下使用，后端开发人员开发服务通过API网关暴露给前端。</p><p><strong>4. 跨语言服务调用：</strong> 中通内部存在多种语言并存的情况，有跨语言调用的情况。</p><p>只需维护一个服务，即可面向多端输出；只需调整API定义，即可实现对APP、设备、web端等多种终端的支持，避免多个场景多套API，大幅降低开发成本。</p><p><img src="0640.jpeg"></p><p>架构与设计</p><p>Architecture and Design</p><p>设计目标</p><p><strong>1. 动态配置：</strong> 能够动态新增API；</p><p><strong>2. 弹性化：</strong> 动态限流与熔断，帮助后端抵挡流量高峰；</p><p><strong>3. 安全性：</strong> 满足不同场景下的鉴权、安全需求；</p><p><strong>4. 无状态：</strong> 更好的支持横向扩展；</p><p><strong>5. 高可用：</strong> 网关作为系统内的单点，必须做到高可用。</p><p><strong>以下是核心功能框架图</strong></p><p><img src="00640.jpeg"></p><p>特点与优势</p><p><strong>1. 安全性：</strong> 网关可为开发者提供多种授权访问API的方式，从而来消除后端代码的授权问题。网关目前支持中天SSO、签名、时间戳、JWT等验证方式。<br><strong>2. 弹性：</strong> 网关可帮助开发人员限制API的并发数和每秒最大请求数，从而让后端操作可以抵挡流量高峰。还可以通过缓存 API 调用的输出来避免每次都调用后端，从而提升性能，并缩短终端用户遇到的延迟。</p><p><strong>3. 生命周期管理：</strong> 在发布了 API 之后，开发人员可能会需要构建和测试增强现有功能或添加新功能的新版本。API 网关 支持可以同时操作修改每个API 版本，以便在发布新 API 版本之后，现有应用可以继续调用先前的版本。Api网关还支持自定义切换版本的规则以便线上灰度测试。</p><p><strong>4. 协议转换：</strong> 网关提供将Dubbo服务转为HTTP协议接口的功能；网关还提供将请求数据投递到用户指定MQ的功能以满足低延迟的需求。</p><p><strong>5. 操作监控：</strong> 当 API 发布并处于使用状态后，网关会为开发者提供指标控制面板，监控对服务的调用情况。涵盖了 API 调用次数、延迟数据和错误率。你还可以在kibana中指定关键词搜索某次调用，也可以通过kibana来自定义统计API的调用情况。</p><p><strong>6. 专为开发者设计：</strong> 通过网关，开发者可以迅速的将服务提供成http接口，并可以根据需求自定义多种授权方式；可以迅速搭建基于天工（内部前端框架）-网关的后台管理系统，开发者无需关注sso、session的问题，专注于业务逻辑的开发。</p><p><strong>7. 节省时间：</strong> 网关提供完善的API文档、调用调试、Mock等功能，开发人员无需自己编写接口文档。</p><p>分层实现</p><p><strong>中通网关在逻辑上分为四层</strong></p><ol><li><p>接入层，负责请求参数的解析</p></li><li><p>拦截器层，负责实现网关鉴权、灰度、限流等核心功能</p></li><li><p>映射层，负责将请求参数映射转换为后端服务所需要的参数</p></li><li><p>调用层，负责将转换后的参数调用后端服务的功能</p></li></ol><p><img src="000640.jpeg"></p><p>高可用</p><p>网关作为一个单点，一旦发生故障是灾难性的，我们采用了以下的设计来增加保障网关的高可用性：<br><strong>1. 限流与熔断：</strong> 我们给API提供了不同维度的限流，基于用户和API的维度，可以对每个用户每分钟（每小时、每天）的调用量做限制，也可以对每个API的并发数量做限制。 在任何分布式环境里，故障是难以避免的，我们经常遇到后端服务异常或者超时的情况，这时我们通过引入hystrix来隔离API，使得一个API出现故障时，不会拖累API网关造成整个API网关故障。又因为我们一个API网关包含了几百个API，如果使用线程池的方式，线程会过多，所以我们采用信号量的方式。我们通过apollo配置中心对hystrix的配置进行管理，使得hystrix配置可以被动态修改。</p><p><strong>2. 线程隔离：</strong> 我们将耗时较长的API隔离开来，放入单独的线程池中执行，当其出现超时或者其他异常时，不会影响其他API的调用。</p><p><strong>3. HTTP服务的负载均衡：</strong> 由于dubbo自带了负载均衡策略，所以我们对http服务做了负载均衡。目前我们对http服务提供了两种策略，一种是普通的轮循，一种是可以感知服务节点状态的轮循，我们参考了netflix ribbon的设计，会定期的访问http服务，如果服务不可用，则将其从可用列表中移除，如果可用，则将其添加到可用列表中去。</p><p><strong>4.</strong> <strong>弱依赖第三方服务：</strong> 我们对所有的API配置、以及Session信息做了本地缓存，在数据库、Redis出现异常时也不影响接口的访问，由此来降低因第三方服务、中间件不稳定导致的网关故障</p><p>网关模块</p><p><strong>1. Gateway Web：</strong> 网关API入口；<br><strong>2. Gateway Portal：</strong> 统一的管理界面，开发人员可以在此创建配置API。</p><p><img src="0000640.jpeg"></p><p>日志与异常</p><p>为了让后端开发人员能方便的查询API调用日志，我们将API调用的参数、耗时、异常等打印到logback，通过logkit收集到kafka，然后消费采集到elasticsearch，通过kibana对日志进行查询和展示。除此之外，我们还定期的对日志进行不同维度的统计（调用量、错误率等），在控制台中展示查询。</p><p>WEB应用SSO插件</p><p>WEB应用SSO插件是我们调研公司内部当前浏览器端开发的情况推出的前端中台解决方案，结合前端的天工模板，旨在解决当前Web开发中存在的问题，提升开发效率。</p><p><strong>这套解决方案有以下的功能：</strong></p><ol><li><p>统一交互前后端交互标准；</p></li><li><p>SSO登入登出、权限控制等均由天工模板、网关来实现；</p></li><li><p>提供统一的数据签名、黑白名单、防刷等安全防护；</p></li><li><p>Apicenter提供统一的文档生成、模拟调用、数据mock功能；</p></li><li><p>提供前端设计器，通过拖拽组件创建前端页面。</p></li></ol><p><strong>下图是接入Web应用接入网关之前与接入之后的情况：</strong></p><p>接入之前：</p><p><img src="00000640.jpeg"><br>接入之后：</p><p><img src="000000640.jpeg"></p><p>技术细节</p><p><strong>全异步化</strong><br>同步调用受限于线程数量，而线程资源宝贵，在 API 网关这类高并发应用场景下，一定比例的 API 超时就会让所有调用的 RT 升高，异步化的引入彻底的隔离 API 之间的影响。网关在 Servlet 线程在进行完 API 调用前置校验后，使用Dubbo和AsyncHttpclient 发起远程服务调用，并结束和回收到该线程</p><ol><li><p>使用异步Servlet</p></li><li><p>使用异步Dubbo</p></li><li><p>使用异步HTTP库（AsyncHttpclient）</p></li></ol><p><img src="0000000640.jpeg"><br><strong>灰度</strong></p><p><strong>原理</strong></p><p>网关支持同一个API有多个版本，在API被调用时，灰度控制相关的拦截器会在后端服务被调用前执行脚本，根据执行结果确定版本。 为了方便开发人员编写，我们支持js和groovy两种语言的脚本。</p><p><img src="00000000640.jpeg"><br><strong>应用场景</strong></p><p>在脚本中，可以取到HTTP请求的参数、header、IP地址等信息，也可以取到当前登录用户的信息。由此，就可以方便的根据请求参数、根据登录用户和网点来决定调用哪个版本的API。</p><p>遇到的问题</p><p>problem</p><p><strong>dubbo初始化导致heap溢出</strong><br>没有提供者的Dubbo服务不能不停的初始化，我们有一次线上好几个节点同时出现了故障，排查出来是dubbo服务不停的初始化造成的内存溢出。是因为线上一个Dubbo服务下线了，但是网关的API没有下线，而且调用方也没有停止调用，就导致这个dubbo服务一直不停的初始化。我们先将API下线，并调整了同一个服务两次初始化的间隔时间临时解决了这个问题。</p><p><strong>后端服务超时导致网关阻塞</strong></p><p>由于servlet默认是阻塞式调用，后端服务大量超时，导致网关线程被占用无法释放，无法接收新的请求，通过异步Servlet和多级线程池的方式，隔离后端服务对网关造成的影响</p><p>总结</p><p>summary</p><p><strong>网关在中通现状</strong><br>中通的API网关目前服务了内部的众多系统——掌中通、掌上神州、网投系统等，目前日均调用量达到13亿，峰值调用约3万qps。</p><p><strong>未来的展望</strong></p><ol><li><p>未来网关将会作为中台解决方案的一员，应用于中通的各种系统，不管是移动端还是浏览器Web端，都有网关的身影；</p></li><li><p>网关将会提供一系列SDK工具，涵盖API的创建，文档的生成与查看，服务的Mock与测试等，为开发人员提供方便的服务。</p></li></ol><div class="post-announce">感谢您的阅读，本文由 <a href="http://tech.izto.com">科技中通</a> 版权所有。如若转载，请注明出处：科技中通（<a href="http://tech.izto.com/2019/05/24/zgw/">http://tech.izto.com/2019/05/24/zgw/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2019/04/30/onedata/" title="数据中台进行曲之OneData探索实践"><i class="iconfont icon-prev"></i>数据中台进行曲之OneData探索实践</a></div><div class="post__prev post__prev--right"><a href="/2019/06/19/test1/" title="中通移动应用功耗测试最佳实践（一）">中通移动应用功耗测试最佳实践（一）<i class="iconfont icon-next"></i></a></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">中通科技是中通快递旗下的互联网物流科技平台，拥有一支千余人规模的研发团队，秉承“互联网+物流”的理念，致力于为客户和消费者提供卓越的物流科技产品与服务，助力产业数字化、智慧化不断发展。</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2020/08/15/es/" title="中通Elasticsearch集群运维实践（二）--监控告警"><div class="item__cover"><img src="/2020/08/15/es/time-line.png" alt="中通Elasticsearch集群运维实践（二）--监控告警"></div><div class="item__info"><h3 class="item__title">中通Elasticsearch集群运维实践（二）--监控告警</h3><span class="item__text">2020-08-15</span></div></a></li><li class="latest-post-item"><a href="/2020/08/15/kafka/" title="Kafka 节点重启失败导致数据丢失的分析排查与解决之道"><div class="item__cover"><img src="/2020/08/15/kafka/640.jpeg" alt="Kafka 节点重启失败导致数据丢失的分析排查与解决之道"></div><div class="item__info"><h3 class="item__title">Kafka 节点重启失败导致数据丢失的分析排查与解决之道</h3><span class="item__text">2020-08-15</span></div></a></li><li class="latest-post-item"><a href="/2020/08/15/zms/" title="中通消息服务运维平台实践（已开源）"><div class="item__cover"><img src="/2020/08/15/zms/1.png" alt="中通消息服务运维平台实践（已开源）"></div><div class="item__info"><h3 class="item__title">中通消息服务运维平台实践（已开源）</h3><span class="item__text">2020-08-15</span></div></a></li><li class="latest-post-item"><a href="/2019/10/15/elasticsearch/" title="中通Elasticsearch集群运维实践"><div class="item__cover"><img src="/2019/10/15/elasticsearch/0640.jpeg" alt="中通Elasticsearch集群运维实践"></div><div class="item__info"><h3 class="item__title">中通Elasticsearch集群运维实践</h3><span class="item__text">2019-10-15</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/API/">API</a></li><li class="tag-item"><a class="tag-link" href="/tags/App/">App</a></li><li class="tag-item"><a class="tag-link" href="/tags/ES/">ES</a></li><li class="tag-item"><a class="tag-link" href="/tags/Gateway/">Gateway</a></li><li class="tag-item"><a class="tag-link" href="/tags/HBase/">HBase</a></li><li class="tag-item"><a class="tag-link" href="/tags/Kafka/">Kafka</a></li><li class="tag-item"><a class="tag-link" href="/tags/MQ/">MQ</a></li><li class="tag-item"><a class="tag-link" href="/tags/RocketMQ/">RocketMQ</a></li><li class="tag-item"><a class="tag-link" href="/tags/Spark/">Spark</a></li><li class="tag-item"><a class="tag-link" href="/tags/Test/">Test</a></li><li class="tag-item"><a class="tag-link" href="/tags/es/">es</a></li><li class="tag-item"><a class="tag-link" href="/tags/http/">http</a></li><li class="tag-item"><a class="tag-link" href="/tags/kabana/">kabana</a></li><li class="tag-item"><a class="tag-link" href="/tags/okhttp/">okhttp</a></li><li class="tag-item"><a class="tag-link" href="/tags/onedata/">onedata</a></li><li class="tag-item"><a class="tag-link" href="/tags/scoket/">scoket</a></li><li class="tag-item"><a class="tag-link" href="/tags/tcp/">tcp</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E4%B8%AD%E9%80%9A/">中通</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%89%8D%E7%AB%AF/">前端</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%8A%9F%E8%80%97/">功耗</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%8D%8F%E8%AE%AE/">协议</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%A4%A7%E6%95%B0%E6%8D%AE/">大数据</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%AE%9E%E8%B7%B5/">实践</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B0%8F%E7%A8%8B%E5%BA%8F/">小程序</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E5%B9%B3%E5%8F%B0/">平台</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%90%9C%E7%B4%A2/">搜索</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%95%B0%E6%8D%AE%E4%B8%AD%E5%8F%B0/">数据中台</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%97%A5%E5%BF%97/">日志</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%B6%88%E6%81%AF/">消息</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%B6%88%E6%81%AF%E9%98%9F%E5%88%97/">消息队列</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%99%BE%E4%BA%BF/">百亿</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%9B%91%E6%8E%A7/">监控</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%A7%BB%E5%8A%A8/">移动</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E7%BD%91%E5%85%B3/">网关</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%B7%A8%E5%B9%B3%E5%8F%B0/">跨平台</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E8%BF%90%E7%BB%B4/">运维</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E9%9B%86%E7%BE%A4/">集群</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">关于</h3><div class="item__content"><p class="item__text">本站是基于 Hexo 搭建的静态资源博客，采用skapp主题，主要用于技术分享，欢迎点击右下角订阅 rss。</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>上海青浦</span></li><li class="contact-info__item"><i class="iconfont icon-email2"></i> <span>xiaowenke@zto.com</span></li></ul></div></div><div class="footer-top__item footer__image"><img src="https://izto.com/static/img/wx.9dba3bb.png" alt="logo" title="科技中通"></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://www.zto.com/" title="中通快递" target="_blank">中通快递</a></li><li class="list-item"><a href="https://izto.com/" title="科技中通" target="_blank">科技中通</a></li><li class="list-item"><a href="https://github.com/Mrminfive/hexo-theme-skapp" title="skapp主题" target="_blank">skapp主题</a></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">构建工具</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://hexo.io/" title="Blog Framework" target="_blank">Hexo博客</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2017 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/ZTO-Express" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="mailto:xiaowenke@zto.com" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["API","Gateway","网关"],gitalk=new Gitalk({clientID:"4cb968a54b00e64ac3cb",clientSecret:"394030211a8ab592146f31cbf54bb9090c0f82d9",repo:"zto-express.github.io",owner:"ZTO-Express",admin:["ZTOGroup"],labels:tags,id:new Date(1558665174e3).getTime()>new Date("2018-02-15").getTime()?md5(location.href):location.href});gitalk.render("comment-container")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>